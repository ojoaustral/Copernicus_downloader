<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Cristian Correa">

<title>Gathering ancillary data for the Coiba POC</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="my_clean_notebook_files/libs/clipboard/clipboard.min.js"></script>
<script src="my_clean_notebook_files/libs/quarto-html/quarto.js"></script>
<script src="my_clean_notebook_files/libs/quarto-html/popper.min.js"></script>
<script src="my_clean_notebook_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="my_clean_notebook_files/libs/quarto-html/anchor.min.js"></script>
<link href="my_clean_notebook_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="my_clean_notebook_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="my_clean_notebook_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="my_clean_notebook_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="my_clean_notebook_files/libs/bootstrap/bootstrap-1bc8a17f135ab3d594c857e9f48e611b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Gathering ancillary data for the Coiba POC</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Cristian Correa </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">Invalid Date</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p><strong>Table of contents</strong><a id="toc0_" href=""></a><br>
- <a href="#toc1_">Libraries</a><br>
- <a href="#toc2_">Import data</a><br>
- <a href="#toc2_1_">Import sample data (sample_data)</a><br>
- <a href="#toc2_2_">Define map extent (area of interest)</a><br>
- <a href="#toc2_2_1_">Sampling dates</a><br>
- <a href="#toc3_">Geographic coordinates</a><br>
- <a href="#toc4_">Copernicus Marine Service</a><br>
- <a href="#toc4_1_">Net Primary Production</a><br>
- <a href="#toc4_1_1_">Extract values from buffer zone</a><br>
- <a href="#toc5_">GIF animation from Copernicus Marine Service data</a></p>
<!-- vscode-jupyter-toc-config
    numbering=false
    anchor=true
    flat=false
    minLevel=1
    maxLevel=6
    /vscode-jupyter-toc-config -->
<!-- THIS CELL WILL BE REPLACED ON TOC UPDATE. DO NOT WRITE YOUR TEXT IN THIS CELL -->
<!-- For more details on using R Markdown see <http://rmarkdown.rstudio.com>. -->
<section id="libraries" class="level1">
<h1><a id="toc1_" href=""></a><a href="#toc0_">Libraries</a></h1>
<div id="cell-4" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>R.version</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>rm(<span class="bu">list</span> <span class="op">=</span> ls())</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>library(tidyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>library(dplyr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>library(ggplot2)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>library(ncdf4) <span class="co"># for *.nc files</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>library(raster)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>library(ggmap)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>library(viridis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>               _                                
platform       x86_64-w64-mingw32               
arch           x86_64                           
os             mingw32                          
crt            ucrt                             
system         x86_64, mingw32                  
status                                          
major          4                                
minor          4.1                              
year           2024                             
month          06                               
day            14                               
svn rev        86737                            
language       R                                
version.string R version 4.4.1 (2024-06-14 ucrt)
nickname       Race for Your Life               </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message:
"package 'tidyr' was built under R version 4.4.3"
Warning message:
"package 'dplyr' was built under R version 4.4.3"

Attaching package: 'dplyr'


The following objects are masked from 'package:stats':

    filter, lag


The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union


Warning message:
"package 'ggplot2' was built under R version 4.4.3"
Warning message:
"package 'raster' was built under R version 4.4.3"
Loading required package: sp

Warning message:
"package 'sp' was built under R version 4.4.3"

Attaching package: 'raster'


The following object is masked from 'package:dplyr':

    select


Warning message:
"package 'ggmap' was built under R version 4.4.3"
ℹ Google's Terms of Service: &lt;https://mapsplatform.google.com&gt;
  Stadia Maps' Terms of Service: &lt;https://stadiamaps.com/terms-of-service/&gt;
  OpenStreetMap's Tile Usage Policy: &lt;https://operations.osmfoundation.org/policies/tiles/&gt;
ℹ Please cite ggmap if you use it! Use `citation("ggmap")` for details.
Warning message:
"package 'viridis' was built under R version 4.4.3"
Loading required package: viridisLite

Warning message:
"package 'viridisLite' was built under R version 4.4.3"</code></pre>
</div>
</div>
<p>In this document and script, various data sources offering worldwide remote-sensing data were queried to retrieve physical and biogeochemical variables with potential predictive power for biodiversity.</p>
<div id="cell-6" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>setwd(<span class="st">"C:/Users/crist/Documents/GitHub/Copernicus_downloader_Coiba/Copernicus_downloader"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="import-data" class="level1">
<h1><a id="toc2_" href=""></a><a href="#toc0_">Import data</a></h1>
<section id="import-sample-data-sample_data" class="level2">
<h2 class="anchored" data-anchor-id="import-sample-data-sample_data"><a id="toc2_1_" href=""></a><a href="#toc0_">Import sample data (sample_data)</a></h2>
<p>Provide a table with sample sites on rows and attributes on columns.</p>
<div id="cell-8" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import sample data</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># (If unavailable, generate a table with site_code, lon, lat, and other attributes  </span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># useing the Sampling_Planner_App)</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>sample_data <span class="op">&lt;-</span> read.csv(<span class="st">"zone_coords_Coiba.csv"</span>) </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename columns</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>sample_data <span class="op">&lt;-</span> sample_data <span class="op">%&gt;%</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  rename(</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    site_code <span class="op">=</span> zone,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    lon <span class="op">=</span> Longitude,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    lat <span class="op">=</span> Latitude)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>head(sample_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A data.frame: 3 × 9</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">site_code</th>
<th data-quarto-table-cell-role="th" scope="col">lat</th>
<th data-quarto-table-cell-role="th" scope="col">lon</th>
<th data-quarto-table-cell-role="th" scope="col">zone_selection_plankton</th>
<th data-quarto-table-cell-role="th" scope="col">zone_selection_eDNA</th>
<th data-quarto-table-cell-role="th" scope="col">zone_selection_eDNA2</th>
<th data-quarto-table-cell-role="th" scope="col">zone_selection_sediment</th>
<th data-quarto-table-cell-role="th" scope="col">zone_selection_sediment2</th>
<th data-quarto-table-cell-role="th" scope="col">Comments</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;lgl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;lgl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;lgl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;lgl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;lgl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;lgl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">1</td>
<td>Z1</td>
<td>7.630140</td>
<td>-81.72629</td>
<td>FALSE</td>
<td>TRUE</td>
<td>FALSE</td>
<td>FALSE</td>
<td>TRUE</td>
<td>NA</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">2</td>
<td>Z2</td>
<td>7.416942</td>
<td>-82.14752</td>
<td>FALSE</td>
<td>TRUE</td>
<td>FALSE</td>
<td>FALSE</td>
<td>TRUE</td>
<td>NA</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">3</td>
<td>Z3</td>
<td>7.606192</td>
<td>-81.58722</td>
<td>FALSE</td>
<td>TRUE</td>
<td>FALSE</td>
<td>FALSE</td>
<td>TRUE</td>
<td>NA</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="define-map-extent-area-of-interest" class="level2">
<h2 class="anchored" data-anchor-id="define-map-extent-area-of-interest"><a id="toc2_2_" href=""></a><a href="#toc0_">Define map extent (area of interest)</a></h2>
<div id="cell-10" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>extent1 <span class="op">&lt;-</span> make_bbox(data <span class="op">=</span> sample_data, lon <span class="op">=</span> lon, lat <span class="op">=</span> lat) </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># extent &lt;- extent(-85, -78, 5, 10)</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>extent2 <span class="op">&lt;-</span> data.frame(lon <span class="op">=</span> c(<span class="op">-</span><span class="dv">85</span>, <span class="op">-</span><span class="dv">78</span>), </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                        lat <span class="op">=</span> c(<span class="dv">5</span>, <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="sampling-dates" class="level3">
<h3 class="anchored" data-anchor-id="sampling-dates"><a id="toc2_2_1_" href=""></a><a href="#toc0_">Sampling dates</a></h3>
<div id="cell-12" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sample_data$SamplingDate &lt;- as.Date(sample_data$Collection_Date)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>daterange <span class="op">&lt;-</span> c(<span class="st">"2015-01-01"</span>, <span class="st">"2025-03-01"</span>) <span class="op">%&gt;%</span> <span class="im">as</span>.Date()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="geographic-coordinates" class="level1">
<h1><a id="toc3_" href=""></a><a href="#toc0_">Geographic coordinates</a></h1>
<p>Identify unique sets of coordinates and average by site if necessary</p>
<div id="cell-15" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Unique coordinates</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>coords <span class="op">&lt;-</span> sample_data <span class="op">%&gt;%</span> reframe(lat <span class="op">=</span> unique(lat), lon <span class="op">=</span> unique(lon))</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>coords</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A data.frame: 3 × 2</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">lat</th>
<th data-quarto-table-cell-role="th" scope="col">lon</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>7.630140</td>
<td>-81.72629</td>
</tr>
<tr class="even">
<td>7.416942</td>
<td>-82.14752</td>
</tr>
<tr class="odd">
<td>7.606192</td>
<td>-81.58722</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Check geographic coordinates and identify potential problems. It may be useful to plot and label the mean site_code of stationary monitoring stations (e.g., temporal sampling in the same bay). In addition, plot the original geographic coordinates, and connect with edges sites under the same site label (all coordinates under the same site label should be close to each other).</p>
<div id="cell-17" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>library(ggmap)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Average coordinates per site </span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>centroids <span class="op">&lt;-</span> sample_data <span class="op">%&gt;%</span> </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  group_by(site_code) <span class="op">%&gt;%</span>  </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  summarise(lon <span class="op">=</span> mean(lon), lat<span class="op">=</span>mean(lat))</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Unique coordinates per site</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>tmp2 <span class="op">&lt;-</span> sample_data <span class="op">%&gt;%</span> </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  group_by(site_code) <span class="op">%&gt;%</span>  </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  distinct(lon, lat)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Set bounding box </span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co"># bbox &lt;- make_bbox(centroids$lon, centroids$lat, f = c(0.3,0.3)) # only works with a range of coordinates</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>bbox <span class="op">&lt;-</span> <span class="bu">round</span>(</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  make_bbox(mean(centroids$lon) <span class="op">+</span> c(<span class="op">-</span><span class="dv">2</span>, <span class="dv">4</span>),</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>            mean(centroids$lat) <span class="op">+</span> c(<span class="op">-</span><span class="fl">1.5</span>, <span class="dv">2</span>))</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>              , <span class="dv">2</span>)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co"># bbox &lt;- make_bbox(extent2$lon, extent2$lat) </span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>cat(<span class="st">"Bounding box: "</span>, bbox, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>register_stadiamaps(key <span class="op">=</span> <span class="st">"f4aaa648-6137-4e34-a850-46c9821d7a6a"</span>)</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="bu">map</span> <span class="op">&lt;-</span> ggmap(get_stadiamap(bbox <span class="op">=</span> bbox, zoom <span class="op">=</span> <span class="dv">7</span>, maptype <span class="op">=</span> <span class="st">"stamen_terrain_background"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Bounding box:  -84.12 5.88 -77.52 9.73 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ℹ © Stadia Maps © Stamen Design © OpenMapTiles © OpenStreetMap contributors.
</code></pre>
</div>
</div>
<div id="cell-18" class="cell" data-fig-width="12" data-fig-height="6">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="my_clean_notebook_files/figure-html/cell-9-output-1.png" width="420" height="420" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Once the map area is defined, it is possible to query remote sensing data sources to retrieve physical and biogeochemical variables. The bounding box of the map area can be used to query data from different sources.</p>
<p>The bounding box coordinates are: - <strong>Left (min longitude):</strong> <code>r bbox[1]</code> - <strong>Bottom (min latitude):</strong> <code>r bbox[2]</code> - <strong>Right (max longitude):</strong> <code>r bbox[3]</code> - <strong>Top (max latitude):</strong> <code>r bbox[4]</code></p>
<p>Can also <code>r dput(bbox)</code> to print the bounding box coordinates.</p>
<div id="cell-20" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>dput(bbox)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>c(left = -84.12, bottom = 5.88, right = -77.52, top = 9.73)</code></pre>
</div>
</div>
<div id="cell-21" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>'bbox'</li><li>'centroids'</li><li>'coords'</li><li>'daterange'</li><li>'extent1'</li><li>'extent2'</li><li>'map'</li><li>'sample_data'</li><li>'tmp2'</li></ol>
</div>
</div>
</section>
<section id="copernicus-marine-service" class="level1">
<h1><a id="toc4_" href=""></a><a href="#toc0_">Copernicus Marine Service</a></h1>
<p>Copernicus Marine presents one of the largest data inventories of high-quality ocean data. The Copernicus Marine Service (or Copernicus Marine Environment Monitoring Service) is the marine component of the Copernicus Programme of the European Union. It provides free, regular and systematic authoritative information on the state of the Blue (physical), White (sea ice) and Green (biogeochemical) ocean, on a global and regional scale. It is funded by the European Commission (EC) and implemented by Mercator Ocean International <a href="https://data.marine.copernicus.eu/products">https://data.marine.copernicus.eu/products</a>.</p>
<p>There are a few options to download the data:</p>
<ol type="1">
<li><p>Downloaded using spatial, temporal, depth, etc., filters directly from the webpage <a href="https://data.marine.copernicus.eu/products">https://data.marine.copernicus.eu/products</a>. Then, the files can be further processed here.</p></li>
<li><p>There is a Phython API called <code>copernicusmarine</code> that can be used to mass-download data. Follows a Python script to download time series in bulk (adapted from <code>Copernicus_data_download.py</code> which I stored on Github).</p></li>
</ol>
<p>Some of the libraries were installed in a virtual environment for this test project. Therefore, before running this jupyter notebook, activate the virtual environment like this:</p>
<p>in bash, navigate to the project’s folder where the .venv is and run</p>
<p>.venv.ps1</p>
<p>Once the virtual environment is activated, run the jupyter notebook</p>
<p>and select the right kernel called “Python (Copernicus Downloader)”</p>
<p>In case the latter isn’t registered, register a new jupyter kernel (this might be done already). pip install ipykernel python -m ipykernel install –user –name=coiba_env –display-name “Python (Copernicus Downloader)”</p>
<div id="cell-23" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">##################################</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Mass-download Copernicus data sets for time series </span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Cristian Correa, March 2025.</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Requires Phython &gt;3.9</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">#################################</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>os.chdir(<span class="st">"./Copernicus_NPP/"</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>os.getcwd()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>'C:\\Users\\crist\\Documents\\GitHub\\Copernicus_downloader_Coiba\\Copernicus_downloader\\Copernicus_NPP'</code></pre>
</div>
</div>
<div id="cell-24" class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clear all variables from the current environment</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> <span class="bu">dir</span>():</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> name.startswith(<span class="st">'_'</span>):</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> <span class="bu">globals</span>()[name]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-25" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sys.executable)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>C:\Users\crist\miniconda3\python.exe</code></pre>
</div>
</div>
<div id="cell-26" class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> copernicusmarine</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cartopy.crs <span class="im">as</span> ccrs</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cartopy.feature <span class="im">as</span> cfeature</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-27" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># User credentials</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>user_ <span class="op">=</span> <span class="st">"ccorrea"</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>pass_ <span class="op">=</span> <span class="st">"Galax1as"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, specify a dataset. Datasets can be found https://data.marine.copernicus.eu/products. Use filters to narrow down the search (e.g., by date range) &gt; choose Product &gt; Data access &gt; Dateset (table) &gt; Form (under Subset column).</p>
<p>Go to Automate tab &gt; Phython API. There you will find an snippet that can be modified and used to download the desired data.</p>
<div id="cell-29" class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>dataset_id <span class="op">=</span> <span class="st">"cmems_mod_glo_bgc_my_0.083deg-lmtl_PT1D-i"</span>  </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>dataset_version <span class="op">=</span> <span class="st">"202411"</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>variables <span class="op">=</span> [<span class="st">"npp"</span>]</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>output_dir <span class="op">=</span> <span class="st">"Copernicus_NPP"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Get the geographical coordinates of the bounding box and the time range of interest.</p>
<div id="cell-31" class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Define geographic extent</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># longitude_bounds = (-122, -121)</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># latitude_bounds = (36, 37)</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co"># longitude_bounds = (-122.431, -121.771)</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># latitude_bounds = (36.285, 37.385)</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>longitude_bounds <span class="op">=</span> (<span class="op">-</span><span class="fl">84.12</span>, <span class="op">-</span><span class="fl">77.52</span>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>latitude_bounds <span class="op">=</span> (<span class="fl">5.88</span>, <span class="fl">9.73</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-32" class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Define date range (daily intervals)</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>start_date <span class="op">=</span> datetime(<span class="dv">2015</span>, <span class="dv">1</span>, <span class="dv">26</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>end_date <span class="op">=</span> datetime(<span class="dv">2016</span>, <span class="dv">12</span>, <span class="dv">31</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>date_range <span class="op">=</span> [start_date <span class="op">+</span> timedelta(days<span class="op">=</span>i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>((end_date <span class="op">-</span> start_date).days <span class="op">+</span> <span class="dv">1</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-33" class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure output directory exists</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>os.makedirs(output_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop over each date (daily downloads)</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> date <span class="kw">in</span> date_range:</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define start and end times (one-day period)</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    start_str <span class="op">=</span> date.strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">T00:00:00"</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    end_str <span class="op">=</span>  date.strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">T23:59:59"</span>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define output filename for this day</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    output_filename <span class="op">=</span> <span class="ss">f"nppv_</span><span class="sc">{</span>date<span class="sc">.</span>strftime(<span class="st">'%Y%m</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss">.nc"</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    output_path <span class="op">=</span> os.path.join(output_dir, output_filename)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skip download if the file already exists</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(output_path):</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"File </span><span class="sc">{</span>output_filename<span class="sc">}</span><span class="ss"> already exists, skipping download."</span>)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Download data for this day</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> copernicusmarine.subset(</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>            dataset_id<span class="op">=</span>dataset_id,</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>            dataset_version<span class="op">=</span>dataset_version,</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>            variables<span class="op">=</span>variables,</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>            minimum_longitude<span class="op">=</span>longitude_bounds[<span class="dv">0</span>],</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>            maximum_longitude<span class="op">=</span>longitude_bounds[<span class="dv">1</span>],</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>            minimum_latitude<span class="op">=</span>latitude_bounds[<span class="dv">0</span>],</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>            maximum_latitude<span class="op">=</span>latitude_bounds[<span class="dv">1</span>],</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>            start_datetime<span class="op">=</span>start_str,</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>            end_datetime<span class="op">=</span>end_str,</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>            coordinates_selection_method<span class="op">=</span><span class="st">"strict-inside"</span>,</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>            minimum_depth<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>            maximum_depth<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>            disable_progress_bar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>            username<span class="op">=</span>user_,</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>            password<span class="op">=</span>pass_</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure the response contains a file path</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(response, <span class="st">"file_path"</span>) <span class="kw">and</span> os.path.exists(response.file_path):</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>            os.rename(response.file_path, output_path)</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Saved daily data for </span><span class="sc">{</span>start_str<span class="sc">}</span><span class="ss"> as </span><span class="sc">{</span>output_filename<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Download failed or file not found for </span><span class="sc">{</span>start_str<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error downloading data for </span><span class="sc">{</span>start_str<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-34" class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># The forlder is populated by *.nc files (one per date in the time series).</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get a description of the data set </span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>catalogue <span class="op">=</span> copernicusmarine.describe(dataset_id <span class="op">=</span> <span class="st">"cmems_mod_glo_bgc_my_0.083deg-lmtl_PT1D-i"</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the output</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>catalogue_dict <span class="op">=</span> catalogue.model_dump(</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    exclude_none<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    exclude_unset<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    exclude<span class="op">=</span>{<span class="st">"products"</span>: {<span class="st">"__all__"</span>: {<span class="st">"datasets"</span>: <span class="va">True</span>, <span class="st">"description"</span>: <span class="va">True</span>, <span class="st">"keywords"</span>: <span class="va">True</span>}}}</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>catalogue_dict[<span class="st">"products"</span>][<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Fetching catalogue:   0%|                                                                                                               | 0/2 [00:00&lt;?, ?it/s]
Fetching products:   0%|                                                                                                                | 0/1 [00:00&lt;?, ?it/s]
Fetching products: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00,  1.21it/s]
Fetching catalogue:  50%|███████████████████████████████████████████████████▌                                                   | 1/2 [00:03&lt;00:03,  3.40s/it]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>{'title': 'Global ocean low and mid trophic levels biomass content hindcast',
 'product_id': 'GLOBAL_MULTIYEAR_BGC_001_033',
 'thumbnail_url': 'https://mdl-metadata.s3.waw3-1.cloudferro.com/metadata/thumbnails/GLOBAL_MULTIYEAR_BGC_001_033.jpg',
 'digital_object_identifier': '10.48670/moi-00020',
 'sources': ['Numerical models'],
 'processing_level': 'Level 4',
 'production_center': 'Mercator Océan International'}</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
</div>
<section id="net-primary-production" class="level2">
<h2 class="anchored" data-anchor-id="net-primary-production"><a id="toc4_1_" href=""></a><a href="#toc0_">Net Primary Production</a></h2>
<p>A time series was downloaded using the <code>Copernicus_data_download.py</code> script. Begin by examining one frame:</p>
<div id="cell-36" class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>setwd(<span class="st">"C:/Users/crist/Documents/GitHub/Copernicus_downloader_Coiba/Copernicus_downloader"</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>rm(<span class="bu">list</span> <span class="op">=</span> ls())</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>library(tidyr)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>library(dplyr)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>library(ggplot2)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>library(ncdf4) <span class="co"># for *.nc files</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>library(raster)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>library(ggmap)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>library(viridis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message:
"package 'tidyr' was built under R version 4.4.3"
Warning message:
"package 'dplyr' was built under R version 4.4.3"

Attaching package: 'dplyr'


The following objects are masked from 'package:stats':

    filter, lag


The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union


Warning message:
"package 'ggplot2' was built under R version 4.4.3"
Warning message:
"package 'raster' was built under R version 4.4.3"
Loading required package: sp

Warning message:
"package 'sp' was built under R version 4.4.3"

Attaching package: 'raster'


The following object is masked from 'package:dplyr':

    select


Warning message:
"package 'ggmap' was built under R version 4.4.3"
ℹ Google's Terms of Service: &lt;https://mapsplatform.google.com&gt;
  Stadia Maps' Terms of Service: &lt;https://stadiamaps.com/terms-of-service/&gt;
  OpenStreetMap's Tile Usage Policy: &lt;https://operations.osmfoundation.org/policies/tiles/&gt;
ℹ Please cite ggmap if you use it! Use `citation("ggmap")` for details.
Warning message:
"package 'viridis' was built under R version 4.4.3"
Loading required package: viridisLite

Warning message:
"package 'viridisLite' was built under R version 4.4.3"</code></pre>
</div>
</div>
<div id="cell-37" class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the path for the NetCDF file</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>ncfile <span class="op">&lt;-</span> <span class="st">"./Copernicus_NPP/Copernicus_NPP/Copernicus_NPP/nppv_20150126.nc"</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co"># # Import NetCDF</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a> nc <span class="op">&lt;-</span> nc_open(ncfile)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(nc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>File ./Copernicus_NPP/Copernicus_NPP/Copernicus_NPP/nppv_20150126.nc (NC_FORMAT_NETCDF4):

     1 variables (excluding dimension variables):
        short npp[longitude,latitude,time]   (Contiguous storage)  
            _FillValue: -32767
            units: mg m-2 day-1
            standard_name: net_primary_productivity_of_biomass_expressed_as_carbon_in_sea_water
            add_offset: 7846.3802682577
            scale_factor: 0.239467138637724

     3 dimensions:
        time  Size:1 
            unit_long: Seconds Since 1970-01-01
            axis: T
            long_name: Time
            standard_name: time
            units: seconds since 1970-01-01
            calendar: standard
        latitude  Size:46 
            axis: Y
            units: degrees_north
            standard_name: latitude
        longitude  Size:79 
            axis: X
            units: degrees_east
            standard_name: longitude

    7 global attributes:
        references: http://www.cls.fr; http://www.seapodym.eu
        source: SEAPODYM-LMTL 3.0.0
        history: Created on 2024-10-17
        institution: CLS
        Conventions: CF-1.7
        title: Global ocean low and mid trophic levels biomass content hindcast
        copernicusmarine_version: 2.0.1</code></pre>
</div>
</div>
<p>Import the nc file as a raster</p>
<div id="cell-39" class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import NetCDF with raster</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>(npp <span class="op">&lt;-</span> raster::raster(ncfile))</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>plot(npp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>class      : RasterLayer 
dimensions : 46, 79, 3634  (nrow, ncol, ncell)
resolution : 0.08333333, 0.08333332  (x, y)
extent     : -84.125, -77.54167, 5.874999, 9.708332  (xmin, xmax, ymin, ymax)
crs        : +proj=longlat +datum=WGS84 +no_defs 
source     : nppv_20150126.nc 
names      : npp 
z-value    : 2015-01-26 
zvar       : npp </code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="my_clean_notebook_files/figure-html/cell-24-output-2.png" width="420" height="420" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Plot one frame along with a reference map and sampling site(s).</p>
<div id="cell-41" class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>bbox <span class="op">&lt;-</span> c(left <span class="op">=</span> <span class="op">-</span><span class="fl">84.12</span>, bottom <span class="op">=</span> <span class="fl">5.88</span>, right <span class="op">=</span> <span class="op">-</span><span class="fl">77.52</span>, top <span class="op">=</span> <span class="fl">9.73</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>bbox_rect <span class="op">&lt;-</span> extent(bbox[<span class="dv">1</span>], bbox[<span class="dv">3</span>], bbox[<span class="dv">2</span>], bbox[<span class="dv">4</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-42" class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raster file</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>npp <span class="op">&lt;-</span> raster(ncfile)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the rectangle (bounding box) around the sampling site</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>bbox_rect <span class="op">&lt;-</span> data.frame(</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  lon <span class="op">=</span> <span class="im">as</span>.vector(attributes(npp)$extent)[<span class="dv">1</span>:<span class="dv">2</span>],  <span class="co"># Longitude bounds</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  lat <span class="op">=</span> <span class="im">as</span>.vector(attributes(npp)$extent)[<span class="dv">3</span>:<span class="dv">4</span>]  <span class="co"># Latitude bounds</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-43" class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>sample_data <span class="op">&lt;-</span> read.csv(<span class="st">"zone_coords_Coiba.csv"</span>) </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename columns</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>centroids <span class="op">&lt;-</span> sample_data <span class="op">%&gt;%</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  rename(</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    site_code <span class="op">=</span> zone,</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    lon <span class="op">=</span> Longitude,</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    lat <span class="op">=</span> Latitude) <span class="op">%&gt;%</span> dplyr::select(site_code, lon, lat) <span class="op">%&gt;%</span> </span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    group_by(site_code) <span class="op">%&gt;%</span> </span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    summarise(lon <span class="op">=</span> mean(lon), lat <span class="op">=</span> mean(lat))</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>centroids</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A tibble: 3 × 3</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">site_code</th>
<th data-quarto-table-cell-role="th" scope="col">lon</th>
<th data-quarto-table-cell-role="th" scope="col">lat</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Z1</td>
<td>-81.72629</td>
<td>7.630140</td>
</tr>
<tr class="even">
<td>Z2</td>
<td>-82.14752</td>
<td>7.416942</td>
</tr>
<tr class="odd">
<td>Z3</td>
<td>-81.58722</td>
<td>7.606192</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="cell-44" class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert raster to dataframe for ggplot2</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>npp_df <span class="op">&lt;-</span> <span class="im">as</span>.data.frame(npp, xy <span class="op">=</span> TRUE, na.rm <span class="op">=</span> TRUE)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>colnames(npp_df) <span class="op">&lt;-</span> c(<span class="st">"lon"</span>, <span class="st">"lat"</span>, <span class="st">"value"</span>)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Define Sampling Site (M0)</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>sampling_site <span class="op">&lt;-</span> centroids <span class="co"># data.frame(lon = -121.901, lat = 36.835, label = "M0")</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute bounding box</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="co"># centroids   # Adjust if you have more sites</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Register and fetch the map</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>register_stadiamaps(key <span class="op">=</span> <span class="st">"f4aaa648-6137-4e34-a850-46c9821d7a6a"</span>)</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="bu">map</span> <span class="op">&lt;-</span> ggmap(get_stadiamap(bbox <span class="op">=</span> bbox, zoom <span class="op">=</span> <span class="dv">5</span>, maptype <span class="op">=</span> <span class="st">"stamen_terrain_background"</span>))</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the raster layer, background map, and sampling site</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="bu">map</span> <span class="op">&lt;-</span> <span class="bu">map</span> <span class="op">+</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>  geom_raster(data <span class="op">=</span> npp_df, aes(x <span class="op">=</span> lon, y <span class="op">=</span> lat, fill <span class="op">=</span> value), alpha <span class="op">=</span> <span class="fl">0.5</span>) <span class="op">+</span>  <span class="co"># Semi-transparent raster</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>  scale_fill_viridis_c(option <span class="op">=</span> <span class="st">"magma"</span>, na.value <span class="op">=</span> <span class="st">"white"</span>) <span class="op">+</span>  <span class="co"># Color scale for raster</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>  geom_point(data <span class="op">=</span> sampling_site, aes(x <span class="op">=</span> lon, y <span class="op">=</span> lat), color <span class="op">=</span> <span class="st">"red"</span>, size <span class="op">=</span> <span class="dv">2</span>) <span class="op">+</span>  <span class="co"># Sampling site</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_polygon(data = bbox_rect, aes(x = lon, y = lat), </span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">#              fill = NA, color = "red", size = 1)+  </span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>  geom_text(data <span class="op">=</span> centroids, aes(x <span class="op">=</span> lon, y <span class="op">=</span> lat, label <span class="op">=</span> site_code), vjust <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>, size <span class="op">=</span> <span class="dv">3</span>, fontface <span class="op">=</span> <span class="st">"bold"</span>) <span class="op">+</span>  </span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>  coord_equal() <span class="op">+</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>  theme_minimal() <span class="op">+</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>  labs(title <span class="op">=</span> <span class="st">"NPP Raster Overlaid on Reference Map"</span>, fill <span class="op">=</span> <span class="st">"NPP Value"</span>, x <span class="op">=</span> <span class="st">"Longitude"</span>, y <span class="op">=</span> <span class="st">"Latitude"</span>)</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a><span class="bu">map</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>ℹ © Stadia Maps © Stamen Design © OpenMapTiles © OpenStreetMap contributors.

Coordinate system already present. Adding new coordinate system, which will replace the existing one.
Warning message:
"Removed 120 rows containing missing values or values outside the scale range (`geom_raster()`)."</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="my_clean_notebook_files/figure-html/cell-28-output-2.png" width="420" height="420" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="my_clean_notebook_files/figure-html/cell-28-output-3.png" width="420" height="420" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="extract-values-from-buffer-zone" class="level3">
<h3 class="anchored" data-anchor-id="extract-values-from-buffer-zone"><a id="toc4_1_1_" href=""></a><a href="#toc0_">Extract values from buffer zone</a></h3>
<p>Examine the possibility to extract grid values from a buffer zone. Define a buffer zone in case you want to use it.</p>
<div id="cell-46" class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load required packages</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>library(ggmap)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>library(ggplot2)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>library(sf)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>buffer_meters <span class="op">&lt;-</span> <span class="dv">20000</span>  <span class="co"># Radius in meters for extraction buffer</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Use original coordinates for extraction buffer or a nearby representative place</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>coords2 <span class="op">&lt;-</span> centroids[<span class="dv">2</span>,]</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="co">#coords2 &lt;- data.frame(lon = -122, lat = 36.8) </span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>coords2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A tibble: 1 × 3</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">site_code</th>
<th data-quarto-table-cell-role="th" scope="col">lon</th>
<th data-quarto-table-cell-role="th" scope="col">lat</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Z2</td>
<td>-82.14752</td>
<td>7.416942</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="cell-47" class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the coordinates into an sf point object</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>coords_sf <span class="op">&lt;-</span> st_as_sf(coords2, coords <span class="op">=</span> c(<span class="st">"lon"</span>, <span class="st">"lat"</span>), crs <span class="op">=</span> <span class="dv">4326</span>) </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Transform to a projected CRS for proper distance measurement (meters)</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>coords_sf <span class="op">&lt;-</span> st_transform(coords_sf, crs <span class="op">=</span> <span class="dv">3857</span>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a circular buffer</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="bu">buffer</span> <span class="op">&lt;-</span> st_buffer(coords_sf, dist <span class="op">=</span> buffer_meters)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Transform back to lat/lon (WGS84) for plotting on ggmap</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="bu">buffer</span> <span class="op">&lt;-</span> st_transform(<span class="bu">buffer</span>, crs <span class="op">=</span> <span class="dv">4326</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-48" class="cell" data-fig-width="12" data-fig-height="6">
<div class="cell-output cell-output-stderr">
<pre><code>Coordinate system already present. Adding new coordinate system, which will replace the existing one.
Warning message:
"Removed 120 rows containing missing values or values outside the scale range (`geom_raster()`)."</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="my_clean_notebook_files/figure-html/cell-31-output-2.png" width="420" height="420" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="my_clean_notebook_files/figure-html/cell-31-output-3.png" width="420" height="420" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Based on the buffer zone selected, extract grid values for each time frame. Extraction is done through <code>raster::extract</code> function. If argument <code>buffer</code> is used, all values contained within the buffer are returned, and if <code>fun</code> is provided in addition, all cell values are collapsed in one values (e.g., mean).</p>
<div id="cell-50" class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>library(raster)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>library(sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-51" class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># output_file &lt;- "cmems_mod_glo_bgc_my_0.083deg-lmtl_PT1D-i__v202411.npp.tsv"</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get list of NetCDF files</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>files <span class="op">&lt;-</span> <span class="bu">list</span>.files(path <span class="op">=</span> <span class="st">"./Copernicus_NPP/Copernicus_NPP/Copernicus_NPP/"</span>,</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>                    pattern <span class="op">=</span> <span class="st">"nppv_.*</span><span class="ch">\\</span><span class="st">.nc$"</span>,  <span class="co"># \ escapes the .</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>                    full.names <span class="op">=</span> TRUE)         <span class="co"># Get full paths</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-52" class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to extract the date from filenames</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>extract_date_from_filename <span class="op">&lt;-</span> function(filename) {</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  match <span class="op">&lt;-</span> regexpr(<span class="st">"nppv_(</span><span class="ch">\\</span><span class="st">d</span><span class="sc">{8}</span><span class="st">)</span><span class="ch">\\</span><span class="st">.nc$"</span>, basename(filename), perl <span class="op">=</span> TRUE)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (match <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span>) {</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    date_str <span class="op">&lt;-</span> sub(<span class="st">"nppv_(</span><span class="ch">\\</span><span class="st">d</span><span class="sc">{8}</span><span class="st">)</span><span class="ch">\\</span><span class="st">.nc$"</span>, <span class="st">"</span><span class="ch">\\</span><span class="st">1"</span>, basename(filename))</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(<span class="im">as</span>.Date(date_str, <span class="bu">format</span> <span class="op">=</span> <span class="st">"%Y%m</span><span class="sc">%d</span><span class="st">"</span>))  <span class="co"># Convert to Date format</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(NA)  <span class="co"># Return NA if no match is found</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-53" class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize output list</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>output_list <span class="op">&lt;-</span> <span class="bu">list</span>()</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through files</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="bu">file</span> <span class="kw">in</span> files) {</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  date <span class="op">&lt;-</span> extract_date_from_filename(<span class="bu">file</span>)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  npp <span class="op">&lt;-</span> raster(<span class="bu">file</span>)  <span class="co"># Load raster</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transform spatial points to match the CRS of the raster</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  coords_sf_transformed <span class="op">&lt;-</span> st_transform(coords_sf, crs <span class="op">=</span> crs(npp))</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract values</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  value <span class="op">&lt;-</span> raster::extract(x <span class="op">=</span> npp, y <span class="op">=</span> coords_sf_transformed, </span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>            <span class="bu">buffer</span> <span class="op">=</span> buffer_meters, fun <span class="op">=</span> mean, na.rm <span class="op">=</span> TRUE, </span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>            small <span class="op">=</span> FALSE, df <span class="op">=</span> TRUE, weights <span class="op">=</span> TRUE)[[<span class="dv">2</span>]]</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store results in a structured way</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>  output_list[[length(output_list) <span class="op">+</span> <span class="dv">1</span>]] <span class="op">&lt;-</span> data.frame(</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> basename(<span class="bu">file</span>),</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>    date <span class="op">=</span> date,</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>    value <span class="op">=</span> value</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine results into a dataframe</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>output_df <span class="op">&lt;-</span> do.call(rbind, output_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-54" class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save as TSV file</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>write.table(output_df, <span class="bu">file</span> <span class="op">=</span> output_file, sep <span class="op">=</span> <span class="st">"</span><span class="ch">\t</span><span class="st">"</span>, row.names <span class="op">=</span> FALSE, quote <span class="op">=</span> FALSE)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>tail(output_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A data.frame: 6 × 3</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">filename</th>
<th data-quarto-table-cell-role="th" scope="col">date</th>
<th data-quarto-table-cell-role="th" scope="col">value</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;date&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">396</td>
<td>nppv_20160225.nc</td>
<td>2016-02-25</td>
<td>346.2845</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">397</td>
<td>nppv_20160226.nc</td>
<td>2016-02-26</td>
<td>409.4738</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">398</td>
<td>nppv_20160227.nc</td>
<td>2016-02-27</td>
<td>422.4649</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">399</td>
<td>nppv_20160228.nc</td>
<td>2016-02-28</td>
<td>531.0034</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">400</td>
<td>nppv_20160229.nc</td>
<td>2016-02-29</td>
<td>575.7239</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">401</td>
<td>nppv_20160301.nc</td>
<td>2016-03-01</td>
<td>404.3253</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="cell-55" class="cell" data-fig-width="12" data-fig-height="6">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="my_clean_notebook_files/figure-html/cell-37-output-1.png" width="420" height="420" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="gif-animation-from-copernicus-marine-service-data" class="level1">
<h1><a id="toc5_" href=""></a><a href="#toc0_">GIF animation from Copernicus Marine Service data</a></h1>
<p>In this section, the raster frames downloaded in the previous section are transformed to <em>.png, and then packed into a </em>.gif animation.</p>
<div id="cell-57" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cartopy.crs <span class="im">as</span> ccrs</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cartopy.feature <span class="im">as</span> cfeature</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> imageio</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.patches <span class="im">import</span> Circle</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-58" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define geographic extent parameters (see output of dput() above to import values here)</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>longitude_bounds <span class="op">=</span> (<span class="op">-</span><span class="fl">84.12</span>, <span class="op">-</span><span class="fl">77.52</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>latitude_bounds <span class="op">=</span> (<span class="fl">5.88</span>, <span class="fl">9.73</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-59" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the background image and get its dimensions for aspect ratio and exact sizing</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>background_path <span class="op">=</span> <span class="st">"NAL Slide theme.png"</span>  <span class="co"># Path to your background image</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>background <span class="op">=</span> Image.<span class="bu">open</span>(background_path).convert(<span class="st">"RGBA"</span>)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>bg_width, bg_height <span class="op">=</span> background.size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-60" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set DPI and calculate figure size based on the background image’s dimensions</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>dpi <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>figsize <span class="op">=</span> (bg_width <span class="op">/</span> dpi, bg_height <span class="op">/</span> dpi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-61" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define proportional outer margin (10% on each side)</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>margin_ratio <span class="op">=</span> <span class="fl">0.05</span>  <span class="co"># 10% margin on all sides</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-62" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Folder paths</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>input_folder <span class="op">=</span> <span class="st">"Copernicus_NPP"</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>output_gif <span class="op">=</span> <span class="st">"nppv_time_series_with_background.gif"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-63" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize an empty list to store file paths for each frame</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>frames <span class="op">=</span> []</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each NetCDF file in the imagery folder</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> file_name <span class="kw">in</span> <span class="bu">sorted</span>(os.listdir(input_folder)):</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> file_name.endswith(<span class="st">".nc"</span>):</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load the NetCDF file</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>        data_path <span class="op">=</span> os.path.join(input_folder, file_name)</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>        ds <span class="op">=</span> xr.open_dataset(data_path)</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Select the first time step and a specific depth to create a 2D slice</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>        nppv <span class="op">=</span> ds[<span class="st">'npp'</span>].isel(time<span class="op">=</span><span class="dv">0</span>)<span class="co">#.sel(depth=0.494, method="nearest")</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>        time_step <span class="op">=</span> <span class="bu">str</span>(ds[<span class="st">'time'</span>].values[<span class="dv">0</span>])[:<span class="dv">10</span>]</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set up the figure with exact background dimensions and DPI</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>        fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>figsize, dpi<span class="op">=</span>dpi)</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Define the axes to center the plotting area and include the outer margin</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> plt.axes([</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>            margin_ratio, margin_ratio <span class="op">+</span> <span class="fl">0.1</span>,  <span class="co"># left and bottom to center the plot</span></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>            <span class="dv">1</span> <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> margin_ratio, <span class="dv">1</span> <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> (margin_ratio <span class="op">+</span> <span class="fl">0.1</span>)  <span class="co"># width and height adjusted for top margin</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>        ], projection<span class="op">=</span>ccrs.PlateCarree())</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>        ax.set_extent([longitude_bounds[<span class="dv">0</span>], longitude_bounds[<span class="dv">1</span>], latitude_bounds[<span class="dv">0</span>], latitude_bounds[<span class="dv">1</span>]], crs<span class="op">=</span>ccrs.PlateCarree())</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add a hollow red circle around Bermuda</span></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">#bermuda_lat = 32.3</span></span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">#bermuda_lon = -64.8</span></span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">#circle_radius = 1  # degrees</span></span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">#circle = Circle((bermuda_lon, bermuda_lat), circle_radius, transform=ccrs.PlateCarree(),</span></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>         <span class="co">#               edgecolor="red", facecolor="none", linewidth=2)</span></span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">#ax.add_patch(circle)</span></span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot the 2D nppv slice without a color bar, setting limits for consistent scaling</span></span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> nppv.plot.imshow(ax<span class="op">=</span>ax, cmap<span class="op">=</span><span class="st">"viridis"</span>, </span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>                               vmin<span class="op">=</span><span class="dv">0</span>, </span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a>                               vmax<span class="op">=</span><span class="dv">800</span>, </span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>                               add_colorbar<span class="op">=</span><span class="va">False</span>, add_labels<span class="op">=</span><span class="va">False</span>, transform<span class="op">=</span>ccrs.PlateCarree())</span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add solid black landmasses without borders</span></span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a>        ax.add_feature(cfeature.LAND, facecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Customize plot title and labels with specified color</span></span>
<span id="cb55-44"><a href="#cb55-44" aria-hidden="true" tabindex="-1"></a>        title_color <span class="op">=</span> <span class="st">"#d3ff22ff"</span></span>
<span id="cb55-45"><a href="#cb55-45" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"</span><span class="sc">{</span>time_step<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">40</span>, color<span class="op">=</span>title_color, loc<span class="op">=</span><span class="st">"right"</span>)</span>
<span id="cb55-46"><a href="#cb55-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-47"><a href="#cb55-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Position color bar adjacent to the plotting area, respecting the outer margin</span></span>
<span id="cb55-48"><a href="#cb55-48" aria-hidden="true" tabindex="-1"></a>        cbar_ax <span class="op">=</span> fig.add_axes([</span>
<span id="cb55-49"><a href="#cb55-49" aria-hidden="true" tabindex="-1"></a>            margin_ratio <span class="op">+</span> <span class="fl">0.15</span>, margin_ratio <span class="op">+</span> <span class="fl">0.05</span>,  <span class="co"># slightly below the plot area</span></span>
<span id="cb55-50"><a href="#cb55-50" aria-hidden="true" tabindex="-1"></a>            <span class="dv">1</span> <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> (margin_ratio <span class="op">+</span> <span class="fl">0.15</span>), <span class="fl">0.03</span>  <span class="co"># set width and height, keeping the margin</span></span>
<span id="cb55-51"><a href="#cb55-51" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb55-52"><a href="#cb55-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb55-53"><a href="#cb55-53" aria-hidden="true" tabindex="-1"></a>        cbar <span class="op">=</span> fig.colorbar(img, cax<span class="op">=</span>cbar_ax, orientation<span class="op">=</span><span class="st">"horizontal"</span>, ticks<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">200</span>, <span class="dv">400</span>, <span class="dv">600</span>, <span class="dv">800</span>])</span>
<span id="cb55-54"><a href="#cb55-54" aria-hidden="true" tabindex="-1"></a>        cbar.set_label(<span class="st">"Carbon concentration (mg m$^{-3}$ day$^{-1}$)"</span>, color<span class="op">=</span>title_color, fontsize<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb55-55"><a href="#cb55-55" aria-hidden="true" tabindex="-1"></a>        cbar.ax.tick_params(colors<span class="op">=</span>title_color, labelsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb55-56"><a href="#cb55-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb55-57"><a href="#cb55-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save the plot with a transparent background, removing extra padding</span></span>
<span id="cb55-58"><a href="#cb55-58" aria-hidden="true" tabindex="-1"></a>        frame_path <span class="op">=</span> os.path.join(input_folder, <span class="ss">f"</span><span class="sc">{</span>time_step<span class="sc">}</span><span class="ss">.png"</span>)</span>
<span id="cb55-59"><a href="#cb55-59" aria-hidden="true" tabindex="-1"></a>        plt.savefig(frame_path, transparent<span class="op">=</span><span class="va">True</span>) <span class="co">#, bbox_inches="tight", pad_inches=0</span></span>
<span id="cb55-60"><a href="#cb55-60" aria-hidden="true" tabindex="-1"></a>        plt.close(fig)</span>
<span id="cb55-61"><a href="#cb55-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-62"><a href="#cb55-62" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Open the saved frame and overlay it on the background</span></span>
<span id="cb55-63"><a href="#cb55-63" aria-hidden="true" tabindex="-1"></a>        frame <span class="op">=</span> Image.<span class="bu">open</span>(frame_path).convert(<span class="st">"RGBA"</span>)</span>
<span id="cb55-64"><a href="#cb55-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-65"><a href="#cb55-65" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Resize background to match the frame’s size if necessary</span></span>
<span id="cb55-66"><a href="#cb55-66" aria-hidden="true" tabindex="-1"></a>        background_resized <span class="op">=</span> background.resize(frame.size)</span>
<span id="cb55-67"><a href="#cb55-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-68"><a href="#cb55-68" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate offsets to center the frame on the background</span></span>
<span id="cb55-69"><a href="#cb55-69" aria-hidden="true" tabindex="-1"></a>        offset_x <span class="op">=</span> (background_resized.width <span class="op">-</span> frame.width) <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb55-70"><a href="#cb55-70" aria-hidden="true" tabindex="-1"></a>        offset_y <span class="op">=</span> (background_resized.height<span class="op">-</span><span class="dv">100</span> <span class="op">-</span> frame.height) <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb55-71"><a href="#cb55-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-72"><a href="#cb55-72" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a new image by pasting the frame onto the centered position of the background</span></span>
<span id="cb55-73"><a href="#cb55-73" aria-hidden="true" tabindex="-1"></a>        combined <span class="op">=</span> Image.new(<span class="st">"RGBA"</span>, background_resized.size)</span>
<span id="cb55-74"><a href="#cb55-74" aria-hidden="true" tabindex="-1"></a>        combined.paste(background_resized, (<span class="dv">0</span>, <span class="dv">0</span>))  <span class="co"># Place background</span></span>
<span id="cb55-75"><a href="#cb55-75" aria-hidden="true" tabindex="-1"></a>        combined.paste(frame, (offset_x, offset_y), mask<span class="op">=</span>frame)  <span class="co"># Center the frame on the background</span></span>
<span id="cb55-76"><a href="#cb55-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-77"><a href="#cb55-77" aria-hidden="true" tabindex="-1"></a>        combined_path <span class="op">=</span> os.path.join(input_folder, <span class="ss">f"combined_</span><span class="sc">{</span>time_step<span class="sc">}</span><span class="ss">.png"</span>)</span>
<span id="cb55-78"><a href="#cb55-78" aria-hidden="true" tabindex="-1"></a>        combined.save(combined_path)  <span class="co"># Save combined image</span></span>
<span id="cb55-79"><a href="#cb55-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-80"><a href="#cb55-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add the combined frame to the list</span></span>
<span id="cb55-81"><a href="#cb55-81" aria-hidden="true" tabindex="-1"></a>        frames.append(combined_path)</span>
<span id="cb55-82"><a href="#cb55-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-83"><a href="#cb55-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the GIF with the combined frames</span></span>
<span id="cb55-84"><a href="#cb55-84" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> imageio.get_writer(output_gif, mode<span class="op">=</span><span class="st">"I"</span>, fps<span class="op">=</span><span class="dv">12</span>, loop<span class="op">=</span><span class="dv">0</span>) <span class="im">as</span> writer:</span>
<span id="cb55-85"><a href="#cb55-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> frame_path <span class="kw">in</span> frames:</span>
<span id="cb55-86"><a href="#cb55-86" aria-hidden="true" tabindex="-1"></a>        image <span class="op">=</span> imageio.imread(frame_path)</span>
<span id="cb55-87"><a href="#cb55-87" aria-hidden="true" tabindex="-1"></a>        writer.append_data(image)</span>
<span id="cb55-88"><a href="#cb55-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-89"><a href="#cb55-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-90"><a href="#cb55-90" aria-hidden="true" tabindex="-1"></a><span class="co"># del image  # Free up the memory used by `image`</span></span>
<span id="cb55-91"><a href="#cb55-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-92"><a href="#cb55-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean up individual frames (optional)</span></span>
<span id="cb55-93"><a href="#cb55-93" aria-hidden="true" tabindex="-1"></a><span class="co"># for frame_path in frames:</span></span>
<span id="cb55-94"><a href="#cb55-94" aria-hidden="true" tabindex="-1"></a><span class="co">#     os.remove(frame_path)</span></span>
<span id="cb55-95"><a href="#cb55-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-96"><a href="#cb55-96" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"GIF saved as </span><span class="sc">{</span>output_gif<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\crist\AppData\Local\Temp\ipykernel_26140\3541563474.py:86: DeprecationWarning: Starting with ImageIO v3 the behavior of this function will switch to that of iio.v3.imread. To keep the current behavior (and make this warning disappear) use `import imageio.v2 as imageio` or call `imageio.v2.imread` directly.
  image = imageio.imread(frame_path)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>GIF saved as nppv_time_series_with_background.gif</code></pre>
</div>
</div>
<p>Note that more sophisticated analyses and visualizations are possible, such and animation of particle advection using ocean currents. Parcels (short for Parcel Lagrangian Ocean Analysis) is a powerful Python library specifically designed to simulate particle movement in ocean flow fields. It’s perfect for visualizing drifters, plankton, pollution, larvae dispersal, etc., using oceanographic data like the one downloaded from Copernicus Marine Services.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>